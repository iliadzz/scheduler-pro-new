<div class="scheduler-container">
    <mat-card class="scheduler-controls">
        <button mat-icon-button aria-label="Undo last action" [matTooltip]="historyService.undoActionName$ | async"
            (click)="historyService.undo()" [disabled]="!(historyService.canUndo$ | async)">
            <mat-icon>rotate_left</mat-icon>
        </button>
        <button mat-icon-button aria-label="Redo last action" [matTooltip]="historyService.redoActionName$ | async"
            (click)="historyService.redo()" [disabled]="!(historyService.canRedo$ | async)">
            <mat-icon>rotate_right</mat-icon>
        </button>

        <div class="control-divider"></div>

        <button mat-flat-button (click)="goToThisWeek()">
            <mat-icon>calendar_today</mat-icon>
            <span i18n="@@schedulerThisWeekButton">This Week</span>
        </button>
        <button mat-flat-button (click)="changeWeek(-7)">
            <mat-icon>arrow_back</mat-icon>
            <span i18n="@@schedulerPrevButton">Prev</span>
        </button>
        <button mat-flat-button class="date-picker-btn" [matMenuTriggerFor]="pickerMenu">
            {{ weekDates[0] | date:'MMM d' }} - {{ weekDates[6] | date:'MMM d, yyyy' }}
        </button>
        <button mat-flat-button (click)="changeWeek(7)">
            <span i18n="@@schedulerNextButton">Next</span>
            <mat-icon>arrow_forward</mat-icon>
        </button>

        <div class="control-divider"></div>

        <button mat-flat-button>
            <mat-icon>content_copy</mat-icon>
            <span i18n="@@schedulerCopyButton">Copy</span>
        </button>
        <button mat-flat-button>
            <span i18n="@@schedulerEventsButton">Events</span>
        </button>
        <button mat-flat-button (click)="onClearWeek()">
            <mat-icon>delete_sweep</mat-icon>
            <span i18n="@@schedulerClearButton">Clear</span>
        </button>
        <button mat-icon-button aria-label="Print schedule">
            <mat-icon>print</mat-icon>
        </button>

        <div class="department-filters">
            @for(dept of (departments$ | async); track dept.id){
            <button mat-stroked-button class="dept-pill" [class.active]="isDepartmentActive(dept.id)"
                (click)="toggleDepartmentFilter(dept.id)">
                {{ dept.abbreviation }}
            </button>
            }
        </div>
    </mat-card>

    <mat-menu #pickerMenu="matMenu" class="hidden-calendar-menu">
        <mat-calendar (selectedChange)="handleDateChange($event)" (click)="$event.stopPropagation()"></mat-calendar>
    </mat-menu>

    @if (scheduleRows$ | async; as rows) {
    <div class="schedule-grid" cdkDropListGroup>
        <div class="header-cell" i18n="@@schedulerEmployeeHeader">Employee</div>
        @for (day of weekDates; track day.getTime()) {
        <div class="header-cell day-header">
            <div>{{ day | date:'EEE' }}</div>
            <div class="day-number">{{ day | date:'d' }}</div>
        </div>
        }

        @for (row of rows; track row.employee.id) {
        <div class="employee-cell">{{ row.employee.displayName }}</div>

        @for (day of row.days; track day.date) {
        <div class="day-cell" cdkDropList
            [cdkDropListData]="{ userId: row.employee.id, date: day.date, schedule: day.schedule }"
            (cdkDropListDropped)="onShiftDrop($event)">
            @for (assignment of day.schedule?.shifts; track assignment.assignmentId) {
            @if (assignment.type === 'shift') {
            <div class="shift-card" cdkDrag [cdkDragData]="assignment" [style.background-color]="assignment.roleColor"
                (click)="$event.stopPropagation(); openShiftForm(row.employee.id, day.date, assignment)">
                <div class="shift-time">{{ assignment.startTime }} - {{ assignment.endTime }}</div>
                <div class="shift-role">{{ assignment.roleName }}</div>
            </div>
            }
            @if (assignment.type === 'time_off') {
            <div class="shift-card time-off-card" cdkDrag [cdkDragData]="assignment"
                (click)="$event.stopPropagation(); openShiftForm(row.employee.id, day.date, assignment)">
                {{ assignment.reason }}
            </div>
            }
            }
        </div>
        }
        }
    </div>
    }
</div>